import 'dart:convert';
import 'dart:io';

import 'package:flutter_test/flutter_test.dart';
import 'package:google_maps_flutter_geojson/google_maps_flutter_geojson.dart';
import 'package:google_maps_flutter_geojson/models/models.dart';
import 'package:google_maps_flutter_geojson/models/properties.dart';

const sampleJson =
    '{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Point","coordinates":[17.1236521,50.85014,0]},"properties":{"name":"pierwszy punkt","styleUrl":"#icon-1899-0288D1-nodesc","styleHash":"-258dc051","styleMapHash":{"normal":"#icon-1899-0288D1-nodesc-normal","highlight":"#icon-1899-0288D1-nodesc-highlight"},"icon":"http://www.gstatic.com/mapspro/images/stock/503-wht-blank_maps.png"}},{"type":"Feature","geometry":{"type":"Point","coordinates":[17.9805857,51.3880324,0]},"properties":{"name":"Drugi punkt","styleUrl":"#icon-1899-0288D1-nodesc","styleHash":"-258dc051","styleMapHash":{"normal":"#icon-1899-0288D1-nodesc-normal","highlight":"#icon-1899-0288D1-nodesc-highlight"},"icon":"http://www.gstatic.com/mapspro/images/stock/503-wht-blank_maps.png"}},{"type":"Feature","geometry":{"type":"LineString","coordinates":[[19.6175486,51.9264508,0],[19.5845896,51.7499558,0],[19.5736033,51.6205409,0],[19.5736033,51.4702297,0],[19.6285349,51.4222992,0],[19.6505076,51.3125549,0],[19.4857127,51.2438311,0],[19.3758494,51.1060748,0],[19.2549998,50.9609876,0],[19.1121775,50.8154459,0],[19.1121775,50.6137117,0],[19.2440135,50.4880604,0],[19.2110545,50.3550651,0],[19.1121775,50.2287248,0],[19.3648631,50.1231849,0],[19.6395213,50.0879531,0],[19.7823435,50.0809037,0],[19.9251658,50.0668016,0]]},"properties":{"name":"Linia 3","styleUrl":"#line-000000-1200-nodesc","styleHash":"c2c637f","styleMapHash":{"normal":"#line-000000-1200-nodesc-normal","highlight":"#line-000000-1200-nodesc-highlight"},"stroke":"#000000","stroke-opacity":1,"stroke-width":1.2}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[21.1556345,53.2150469,0],[19.0682322,52.8251394,0],[19.6614939,52.4718736,0],[20.5074412,51.9738505,0],[21.606074,52.5788207,0],[21.1556345,53.2150469,0]]]},"properties":{"name":"WielokÄ…t 4","styleUrl":"#poly-AFB42B-4501-171-nodesc","styleHash":"-70f9e379","styleMapHash":{"normal":"#poly-AFB42B-4501-171-nodesc-normal","highlight":"#poly-AFB42B-4501-171-nodesc-highlight"},"stroke":"#afb42b","stroke-opacity":1,"stroke-width":4.501,"fill":"#afb42b","fill-opacity":0.6705882352941176}},{"type":"Feature","geometry":{"type":"MultiPolygon","coordinates":[[[[0, 0], [1, 1], [0, 1], [0, 0]],[[0,0], [0,1], [1,0]]]]},"properties":{"name":"Test"}}]}';
const multipolygon =
    '{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"MultiPolygon","coordinates":[[[[0, 0], [1, 1], [0, 1], [0, 0]],[[0,0], [0,1], [1,0]],[[0,0], [2,0], [1,0]]]]},"properties":{"name":"Test"}}]}';
const emptyMultipolygon =
    '{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"MultiPolygon","coordinates":[[], [[[0, 0], [1, 1], [0, 1], [0, 0]],[[0,0], [0,1], [1,0]],[[0,0], [2,0], [1,0]]]]},"properties":{"name":"Test"}}]}';
const emptyPolygon =
    '{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[]},"properties":{"name":"Test"}}]}';
const googleCropCover =
 '{"type":"FeatureCollection","bbox":[-122.0865494,37.4208858,-122.0821145,37.4233113],"features":[{"type":"Feature","properties":{"categorization_code":122,"title":"Developed/Low Intensity","fill":"#9a9a9a","fill-opacity":1.0},"bbox":[-122.0865219,37.4209992,-122.0821145,37.42328],"geometry":{"type":"MultiPolygon","coordinates":[[[[-122.085807,37.4231842],[-122.0858171,37.4232123],[-122.086197,37.42328],[-122.0861364,37.4231116],[-122.085807,37.4231842]]],[[[-122.0850554,37.4230717],[-122.0850605,37.4230858],[-122.0852971,37.4231196],[-122.0854372,37.4231446],[-122.0853848,37.4229991],[-122.0850554,37.4230717]]],[[[-122.0864088,37.4223813],[-122.0864274,37.4222132],[-122.0861876,37.4222661],[-122.0862803,37.4225237],[-122.0859509,37.4225963],[-122.0860437,37.422854],[-122.0863731,37.4227814],[-122.0863851,37.4228147],[-122.0863933,37.4224835],[-122.0864088,37.4223813]]],[[[-122.0843038,37.4229591],[-122.08432,37.4230039],[-122.0845068,37.423019],[-122.0846883,37.4230393],[-122.0846333,37.4228865],[-122.0843038,37.4229591]]],[[[-122.0851066,37.4222261],[-122.085436,37.4221535],[-122.0852505,37.4216382],[-122.0849211,37.4217107],[-122.0851066,37.4222261]]],[[[-122.0822858,37.4222912],[-122.0825351,37.4229837],[-122.0829088,37.4229628],[-122.0833091,37.4229587],[-122.0837092,37.4229667],[-122.0839555,37.4229791],[-122.0838817,37.422774],[-122.0832229,37.4229191],[-122.0831301,37.4226614],[-122.0834595,37.4225889],[-122.0833668,37.4223312],[-122.0827079,37.4224763],[-122.0826152,37.4222186],[-122.0822858,37.4222912]]],[[[-122.0862387,37.4214205],[-122.0864501,37.4220078],[-122.0865219,37.4213581],[-122.0862387,37.4214205]]],[[[-122.084355,37.4221135],[-122.0846844,37.4220409],[-122.0845916,37.4217833],[-122.0842622,37.4218558],[-122.084355,37.4221135]]],[[[-122.083274,37.4220735],[-122.0839328,37.4219284],[-122.0838401,37.4216707],[-122.0831813,37.4218158],[-122.083274,37.4220735]]],[[[-122.0823369,37.4214456],[-122.0821155,37.4214943],[-122.0821145,37.4218152],[-122.082193,37.4220335],[-122.0828518,37.4218884],[-122.0827591,37.4216307],[-122.0824297,37.4217032],[-122.0823369,37.4214456]]],[[[-122.0843523,37.4210017],[-122.0843094,37.4209992],[-122.0843134,37.4210102],[-122.0843523,37.4210017]]]]}},{"type":"Feature","properties":{"categorization_code":123,"title":"Developed/Med Intensity","fill":"#9a9a9a","fill-opacity":1.0},"bbox":[-122.0865494,37.4208858,-122.0821514,37.4233113],"geometry":{"type":"MultiPolygon","coordinates":[[],[[[-122.0859509,37.4225963],[-122.0862803,37.4225237],[-122.0861876,37.4222661],[-122.0858581,37.4223386],[-122.0859509,37.4225963]]],[[[-122.0861876,37.4222661],[-122.0864274,37.4222132],[-122.0864501,37.4220078],[-122.0863314,37.4216781],[-122.086002,37.4217507],[-122.0861876,37.4222661]]],[[[-122.0838817,37.422774],[-122.0839555,37.4229791],[-122.0841086,37.4229868],[-122.0841594,37.4229909],[-122.0846333,37.4228865],[-122.0846883,37.4230393],[-122.0849032,37.4230633],[-122.0850184,37.4230798],[-122.0853848,37.4229991],[-122.0854372,37.4231446],[-122.085741,37.4231987],[-122.0861364,37.4231116],[-122.086197,37.42328],[-122.0863728,37.4233113],[-122.0863736,37.4232771],[-122.0863851,37.4228147],[-122.0863731,37.4227814],[-122.0857143,37.4229265],[-122.0856215,37.4226689],[-122.0852921,37.4227414],[-122.0851993,37.4224837],[-122.0855287,37.4224112],[-122.085436,37.4221535],[-122.0851066,37.4222261],[-122.0849211,37.4217107],[-122.0845916,37.4217833],[-122.0848699,37.4225563],[-122.0838817,37.422774]]],[],[[[-122.0849256,37.4210349],[-122.0843523,37.4210017],[-122.0843134,37.4210102],[-122.0843094,37.4209992],[-122.0823531,37.4208858],[-122.0821514,37.4209302],[-122.0824297,37.4217032],[-122.0827591,37.4216307],[-122.0828518,37.4218884],[-122.082193,37.4220335],[-122.0822858,37.4222912],[-122.0826152,37.4222186],[-122.0827079,37.4224763],[-122.0833668,37.4223312],[-122.0834595,37.4225889],[-122.0831301,37.4226614],[-122.0832229,37.4229191],[-122.0838817,37.422774],[-122.0836962,37.4222586],[-122.084355,37.4221135],[-122.0841695,37.4215982],[-122.0838401,37.4216707],[-122.0839328,37.4219284],[-122.083274,37.4220735],[-122.0831813,37.4218158],[-122.0835107,37.4217433],[-122.0834179,37.4214856],[-122.0830885,37.4215581],[-122.0829957,37.4213005],[-122.083984,37.4210828],[-122.0840767,37.4213405],[-122.0847355,37.4211954],[-122.0849211,37.4217107],[-122.0852505,37.4216382],[-122.0853432,37.4218958],[-122.0856726,37.4218233],[-122.0854871,37.4213079],[-122.0858165,37.4212354],[-122.0859093,37.421493],[-122.0865219,37.4213581],[-122.0865463,37.4211376],[-122.0865494,37.4211095],[-122.0858503,37.421099],[-122.0856592,37.4210923],[-122.0855639,37.4210858],[-122.0849256,37.4210349]]]]}},{"type":"Feature","properties":{"categorization_code":124,"title":"Developed/High Intensity","fill":"#9a9a9a","fill-opacity":1.0},"bbox":[-122.0863314,37.4210828,-122.0829957,37.4229265],"geometry":{"type":"MultiPolygon","coordinates":[[[[-122.0838817,37.422774],[-122.0848699,37.4225563],[-122.0846844,37.4220409],[-122.0836962,37.4222586],[-122.0838817,37.422774]]],[[[-122.0857143,37.4229265],[-122.0860437,37.422854],[-122.0858581,37.4223386],[-122.0861876,37.4222661],[-122.086002,37.4217507],[-122.0863314,37.4216781],[-122.0862387,37.4214205],[-122.0859093,37.421493],[-122.0858165,37.4212354],[-122.0854871,37.4213079],[-122.0856726,37.4218233],[-122.0853432,37.4218958],[-122.0855287,37.4224112],[-122.0851993,37.4224837],[-122.0852921,37.4227414],[-122.0856215,37.4226689],[-122.0857143,37.4229265]]],[[[-122.0842622,37.4218558],[-122.0849211,37.4217107],[-122.0847355,37.4211954],[-122.0840767,37.4213405],[-122.083984,37.4210828],[-122.0829957,37.4213005],[-122.0830885,37.4215581],[-122.0834179,37.4214856],[-122.0835107,37.4217433],[-122.0841695,37.4215982],[-122.0842622,37.4218558]]]]}}]}';

void main() {
  test('Parse geojson sample', () {
    var result = GeoJSONParser.parse(jsonDecode(sampleJson));
    expect(result.features[0].geometry is Point, true);
    expect( result.features[1].geometry is Point, true);
    expect(result.features[2].geometry is LineString, true);
    expect(result.features[3].geometry is Polygon, true);
    expect(result.features[4].geometry is MultiPolygon, true);
  });

  test('Parse and convert to google maps items', () {
    var result = GeoJSONGoogleMapsResult.fromJson(jsonDecode(sampleJson));
    expect(result.polygons.length, 2);
    expect(result.polylines.length, 1);
    expect(result.markers.length, 2);
  });

  test('Parse multipolygon with holes', () {
    var result = GeoJSONGoogleMapsResult.fromJson(jsonDecode(multipolygon));
    expect(result.polygons.length, 1);
    expect(result.polygons.first.holes.length, 2);
  });

  test('Parse empty multipolygon', () {
    var result = GeoJSONGoogleMapsResult.fromJson(jsonDecode(emptyMultipolygon));
    expect(result.polygons.length, 1);
  });

  test('Parse empty polygon', () {
    var result = GeoJSONGoogleMapsResult.fromJson(jsonDecode(emptyPolygon));
    expect(result.polygons.length, 0);
  });

  test('Parse Google crop coverage', () {
    var result = GeoJSONGoogleMapsResult.fromJson(jsonDecode(googleCropCover));
    expect(result.polygons.length, 18);
  });

  test('Parse custom properties', () {
    const customProperties = '{'
        '"type":"FeatureCollection",'
        '"bbox":[-122.0865494,37.4208858,-122.0821145,37.4233113],'
        '"features":['
          '{'
            '"type":"Feature",'
            '"properties":{'
              '"code":12,'
              '"title":"Building",'
              '"description":"2 Story Hotel",'
              '"fill":"#9a9a9a",'
              '"fill-opacity":1.0'
          '},'
          '"bbox":[-122.0865219,37.4209992,-122.0821145,37.42328],'
          '"geometry":{"type":"MultiPolygon","coordinates":[[[[-122.085807,37.4231842],[-122.0858171,37.4232123],[-122.086197,37.42328],[-122.0861364,37.4231116],[-122.085807,37.4231842]]],[[[-122.0850554,37.4230717],[-122.0850605,37.4230858],[-122.0852971,37.4231196],[-122.0854372,37.4231446],[-122.0853848,37.4229991],[-122.0850554,37.4230717]]],[[[-122.0864088,37.4223813],[-122.0864274,37.4222132],[-122.0861876,37.4222661],[-122.0862803,37.4225237],[-122.0859509,37.4225963],[-122.0860437,37.422854],[-122.0863731,37.4227814],[-122.0863851,37.4228147],[-122.0863933,37.4224835],[-122.0864088,37.4223813]]],[[[-122.0843038,37.4229591],[-122.08432,37.4230039],[-122.0845068,37.423019],[-122.0846883,37.4230393],[-122.0846333,37.4228865],[-122.0843038,37.4229591]]],[[[-122.0851066,37.4222261],[-122.085436,37.4221535],[-122.0852505,37.4216382],[-122.0849211,37.4217107],[-122.0851066,37.4222261]]],[[[-122.0822858,37.4222912],[-122.0825351,37.4229837],[-122.0829088,37.4229628],[-122.0833091,37.4229587],[-122.0837092,37.4229667],[-122.0839555,37.4229791],[-122.0838817,37.422774],[-122.0832229,37.4229191],[-122.0831301,37.4226614],[-122.0834595,37.4225889],[-122.0833668,37.4223312],[-122.0827079,37.4224763],[-122.0826152,37.4222186],[-122.0822858,37.4222912]]],[[[-122.0862387,37.4214205],[-122.0864501,37.4220078],[-122.0865219,37.4213581],[-122.0862387,37.4214205]]],[[[-122.084355,37.4221135],[-122.0846844,37.4220409],[-122.0845916,37.4217833],[-122.0842622,37.4218558],[-122.084355,37.4221135]]],[[[-122.083274,37.4220735],[-122.0839328,37.4219284],[-122.0838401,37.4216707],[-122.0831813,37.4218158],[-122.083274,37.4220735]]],[[[-122.0823369,37.4214456],[-122.0821155,37.4214943],[-122.0821145,37.4218152],[-122.082193,37.4220335],[-122.0828518,37.4218884],[-122.0827591,37.4216307],[-122.0824297,37.4217032],[-122.0823369,37.4214456]]],[[[-122.0843523,37.4210017],[-122.0843094,37.4209992],[-122.0843134,37.4210102],[-122.0843523,37.4210017]]]]}},'
        '{'
        '"type":"Feature",'
        '"properties":'
        '{"code":123,"title":"Developed/Med Intensity","fill":"#9a9a9a","fill-opacity":1.0},'
        '"bbox":[-122.0865494,37.4208858,-122.0821514,37.4233113],'
        '"geometry":{'
        '"type":"MultiPolygon","coordinates":[[],[[[-122.0859509,37.4225963],[-122.0862803,37.4225237],[-122.0861876,37.4222661],[-122.0858581,37.4223386],[-122.0859509,37.4225963]]],[[[-122.0861876,37.4222661],[-122.0864274,37.4222132],[-122.0864501,37.4220078],[-122.0863314,37.4216781],[-122.086002,37.4217507],[-122.0861876,37.4222661]]],[[[-122.0838817,37.422774],[-122.0839555,37.4229791],[-122.0841086,37.4229868],[-122.0841594,37.4229909],[-122.0846333,37.4228865],[-122.0846883,37.4230393],[-122.0849032,37.4230633],[-122.0850184,37.4230798],[-122.0853848,37.4229991],[-122.0854372,37.4231446],[-122.085741,37.4231987],[-122.0861364,37.4231116],[-122.086197,37.42328],[-122.0863728,37.4233113],[-122.0863736,37.4232771],[-122.0863851,37.4228147],[-122.0863731,37.4227814],[-122.0857143,37.4229265],[-122.0856215,37.4226689],[-122.0852921,37.4227414],[-122.0851993,37.4224837],[-122.0855287,37.4224112],[-122.085436,37.4221535],[-122.0851066,37.4222261],[-122.0849211,37.4217107],[-122.0845916,37.4217833],[-122.0848699,37.4225563],[-122.0838817,37.422774]]],[],[[[-122.0849256,37.4210349],[-122.0843523,37.4210017],[-122.0843134,37.4210102],[-122.0843094,37.4209992],[-122.0823531,37.4208858],[-122.0821514,37.4209302],[-122.0824297,37.4217032],[-122.0827591,37.4216307],[-122.0828518,37.4218884],[-122.082193,37.4220335],[-122.0822858,37.4222912],[-122.0826152,37.4222186],[-122.0827079,37.4224763],[-122.0833668,37.4223312],[-122.0834595,37.4225889],[-122.0831301,37.4226614],[-122.0832229,37.4229191],[-122.0838817,37.422774],[-122.0836962,37.4222586],[-122.084355,37.4221135],[-122.0841695,37.4215982],[-122.0838401,37.4216707],[-122.0839328,37.4219284],[-122.083274,37.4220735],[-122.0831813,37.4218158],[-122.0835107,37.4217433],[-122.0834179,37.4214856],[-122.0830885,37.4215581],[-122.0829957,37.4213005],[-122.083984,37.4210828],[-122.0840767,37.4213405],[-122.0847355,37.4211954],[-122.0849211,37.4217107],[-122.0852505,37.4216382],[-122.0853432,37.4218958],[-122.0856726,37.4218233],[-122.0854871,37.4213079],[-122.0858165,37.4212354],[-122.0859093,37.421493],[-122.0865219,37.4213581],[-122.0865463,37.4211376],[-122.0865494,37.4211095],[-122.0858503,37.421099],[-122.0856592,37.4210923],[-122.0855639,37.4210858],[-122.0849256,37.4210349]]]]}},{"type":"Feature",'
        '"properties":{"code":14,"title":"Developed/High Intensity","fill":"#9a9a9a","fill-opacity":1.0},"bbox":[-122.0863314,37.4210828,-122.0829957,37.4229265],"geometry":{"type":"MultiPolygon","coordinates":[[[[-122.0838817,37.422774],[-122.0848699,37.4225563],[-122.0846844,37.4220409],[-122.0836962,37.4222586],[-122.0838817,37.422774]]],[[[-122.0857143,37.4229265],[-122.0860437,37.422854],[-122.0858581,37.4223386],[-122.0861876,37.4222661],[-122.086002,37.4217507],[-122.0863314,37.4216781],[-122.0862387,37.4214205],[-122.0859093,37.421493],[-122.0858165,37.4212354],[-122.0854871,37.4213079],[-122.0856726,37.4218233],[-122.0853432,37.4218958],[-122.0855287,37.4224112],[-122.0851993,37.4224837],[-122.0852921,37.4227414],[-122.0856215,37.4226689],[-122.0857143,37.4229265]]],[[[-122.0842622,37.4218558],[-122.0849211,37.4217107],[-122.0847355,37.4211954],[-122.0840767,37.4213405],[-122.083984,37.4210828],[-122.0829957,37.4213005],[-122.0830885,37.4215581],[-122.0834179,37.4214856],[-122.0835107,37.4217433],[-122.0841695,37.4215982],[-122.0842622,37.4218558]]]]}}]}';

    final j = jsonDecode(customProperties);
    final result = CustomGeoJSONGoogleMapsResult<_CustomProperties>.fromJson(j, (json) => _CustomProperties.fromJson(json as Map<String, dynamic>));
    final features = result.features.first;
    expect(features.properties.code, equals(12));
    expect(features.polygons.length, equals(11));
  });

  test('Parse multipolygon with multiple polygons and holes', () {
    final inputString = File('json/multipolygon_with_holes.json')
        .readAsStringSync();
    final j = jsonDecode(inputString);
    final result = GeoJSONGoogleMapsResult.fromJson(j);

    final polygons = result.polygons;
    expect(result.features.any((f) => f.properties.title?.isEmpty ?? true), equals(false));
    expect(result.features.length, equals(8));
    expect(polygons.length, equals(36));
    expect(polygons.expand((p) => p.holes).length, equals(6));
  });
}

class _CustomProperties extends Properties {
  final String? description;
  final int code;

  _CustomProperties(
    super.stroke,
    super.strokeWidth,
    super.strokeOpacity,
    super.fill,
    super.fillOpacity,
    super.title,
    this.description,
    this.code
  );

  factory _CustomProperties.fromJson(Map<String, dynamic> json) {
    return _CustomProperties(
        null, // stroke
        json['stroke-width'] as double?,
        json['stroke-opacity'] as double?,
        null, // fill
        json['fill-opacity'] as double?,
        json['title'] as String?,
        json['description'] as String?,
        json['code'] as int,
    );
  }
}